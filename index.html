<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>주간 보드</title>

  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">

  <style>
    :root{
      --bg:#ffffff;
      --card:#f7f7f8;
      --line:#d9d9de;
      --text:#1f2328;

      --done-bg:#eef0f3;
      --done-border:#c9ced6;
      --done-text:#6f7782;

      --radius:14px;
      --gap:10px;
      --ui-gap:10px;

      --shadow: 0 14px 34px rgba(16,24,40,.18);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
    }
    .app{ max-width:1080px; margin:0 auto; padding:12px; }

    .panel{
      border:1.5px solid var(--line);
      border-radius:var(--radius);
      background:var(--card);
      padding:10px;
      margin-bottom:12px;
    }

    /* 상단 입력 */
    .add-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:stretch;
    }

    .add-row input{
      border:1px solid #c8cad0;
      border-radius:10px;
      height:38px;
      padding:0 12px;
      font-size:14px;
      background:#fff;
      color:#111827;
      font-weight:600;
    }

    /* ✅ 안내 문구(placeholder) 강조 낮춤 */
    .add-row input::placeholder{
      color:#9aa3b2;
      font-weight:400;
    }

    #taskInput{ flex:1 1 260px; min-width:170px; }
    #noteInput{ flex:1 1 380px; min-width:220px; font-weight:500; color:#2f3a4a; }

    .add-row button{
      border:1px solid #c8cad0;
      background:#fff;
      border-radius:10px;
      height:38px;
      padding:0 12px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      white-space:nowrap;
    }

    /* 주간 보드 */
    .week{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }

    .day{
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      min-height:120px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    .day-head{
      padding:8px 10px;
      font-weight:400;
      font-size:14px;
      border-bottom:1px solid #ececf0;
      background:#fafafa;
      cursor:pointer;
      transition:background .15s, border-bottom-color .15s;
      user-select:none;
    }
    .day.selected .day-head{
      background:#eaf3ff;
      border-bottom-color:#d7e6ff;
    }

    .slot{
      padding:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-content:flex-start;
      min-height:84px;
      cursor:pointer;
    }

    /* 칩 */
    .chip{
      height:42px;
      border:1px solid #b8bbc2;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:0 12px;

      font-weight:500;
      font-size:14px;

      user-select:none;
      cursor:pointer;
      position:relative;
      width:auto;
      max-width:100%;
      touch-action:manipulation; /* 스크롤과 싸움 줄이기 */
    }

    .chip-text{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
      flex:0 1 auto;
      font-weight:500;
    }

    .ck-count{
      flex:0 0 auto;
      font-size:12px;
      font-weight:600;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      background:rgba(255,255,255,.65);
      color:#374151;
      display:none;
    }
    .chip.has-ck .ck-count{ display:inline-flex; }

    /* 완료 스타일 */
    .chip.done{
      background:var(--done-bg) !important;
      border-color:var(--done-border) !important;
      color:var(--done-text);
    }
    .chip.done .chip-text{
      text-decoration:line-through;
      text-decoration-thickness:1.5px;
      opacity:.9;
    }
    .chip.done .ck-count{
      color:var(--done-text);
      border-color:var(--done-border);
      background:rgba(238,240,243,.9);
      opacity:.95;
    }

    /* 드래그 중 고스트 */
    .drag-ghost{
      position:fixed;
      z-index:2000;
      pointer-events:none;
      opacity:.92;
      transform:translate(-50%,-50%);
      box-shadow: var(--shadow);
    }
    .drag-placeholder{
      width:46px;
      height:42px;
      border-radius:999px;
      border:2px dashed rgba(148,163,184,.7);
      background:rgba(148,163,184,.08);
    }

    /* 하단 버튼 */
    .toolbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .toolbar button{
      border:1px solid #c8cad0;
      background:#fff;
      border-radius:10px;
      height:38px;
      padding:0 12px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
    }

    /* 모달 */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(255,255,255,0.01);
      backdrop-filter:blur(2px);
      -webkit-backdrop-filter:blur(2px);
      opacity:0;
      display:none;
      z-index:50;
      transition:opacity .14s ease;
    }
    .modal-backdrop.show{ opacity:1; }

    /* 팝오버 */
    .note-pop{
      position:fixed;
      z-index:60;
      width:min(360px, calc(100vw - 24px));
      max-height:calc(100vh - 24px);
      overflow:auto;

      background:#fff;
      border:1px solid #d7dce6;
      border-radius:12px;
      box-shadow: var(--shadow);

      padding:12px;

      display:none;
      opacity:0;
      transform:translateY(6px);
      transition:opacity .14s ease, transform .14s ease;

      flex-direction:column;
      gap:var(--ui-gap);
    }
    .note-pop.show{ opacity:1; transform:translateY(0); }

    .note-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .note-top .ttl{
      font-size:16px;
      font-weight:600;
      color:#2f3a4a;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      line-height:1.25;
    }
    .note-actions{
      display:flex;
      gap:8px;
      flex:0 0 auto;
      align-items:center;
    }
    .note-btn{
      border:1px solid #c8cad0;
      background:#fff;
      border-radius:9px;
      height:34px;
      padding:0 10px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      white-space:nowrap;
    }

    .note-danger{
      border-color: rgba(239,68,68,.45);
      color:#b42318;
      background:#fff;
    }

    .note-body{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(255,255,255,.68);
      padding:7px 8px;
      min-height:44px;

      display:flex;
      align-items:center;
      justify-content:flex-start;
      text-align:left;

      font-size:13px;
      line-height:1.5;
      color:#243041;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .note-empty{ color:#8a93a2; font-style:normal; }

    /* 수정 모드 */
    .edit-wrap{
      display:none;
      flex-direction:column;
      gap:var(--ui-gap);
    }
    .edit-wrap input, .edit-wrap textarea{
      width:100%;
      border:1px solid rgba(148,163,184,.45);
      border-radius:10px;
      background:rgba(255,255,255,.85);
      color:#111827;
      font-size:13px;
      padding:8px 10px;
      outline:none;
      font-weight:500;
    }
    .edit-wrap textarea{
      min-height:84px;
      resize:vertical;
      line-height:1.5;
    }
    .edit-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }

    /* 체크리스트 */
    .check-wrap{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:var(--ui-gap);
    }
    .check-list{
      display:flex;
      flex-direction:column;
      gap:var(--ui-gap);
      margin:0;
      padding:0;
      max-height:220px;
      overflow:auto;
      padding-right:2px;
    }
    .check-item{
      display:flex;
      align-items:flex-start;
      gap:8px;
      border:1px solid rgba(148,163,184,.35);
      border-radius:10px;
      padding:7px 8px;
      background:rgba(255,255,255,.68);
    }
    .check-item.done{
      opacity:.78;
      background:rgba(238,240,243,.85);
    }
    .check-toggle{
      margin-top:2px;
      width:16px;
      height:16px;
      flex:0 0 auto;
      cursor:pointer;
    }
    .check-text{
      flex:1 1 auto;
      font-size:13px;
      line-height:1.45;
      color:#243041;
      word-break:break-word;
    }
    .check-item.done .check-text{
      text-decoration:line-through;
      color:#6b7280;
    }
    .check-del{
      width:22px;
      height:22px;
      border:1px solid #c8cad0;
      border-radius:50%;
      background:#fff;
      color:#6b7280;
      font-size:13px;
      line-height:1;
      padding:0;
      cursor:pointer;
      flex:0 0 auto;
    }
    .check-add{
      display:flex;
      gap:var(--ui-gap);
      align-items:center;
    }
    .check-add input{
      flex:1 1 auto;
      height:34px;
      border:1px solid #cbd5e1;
      border-radius:9px;
      padding:0 10px;
      font-size:13px;
      background:rgba(255,255,255,.85);
      color:#111827;
      font-weight:500;
    }
    /* ✅ 체크리스트 안내 문구(placeholder) 강조 낮춤 */
    .check-add input::placeholder{ color:#9aa3b2; font-weight:400; }

    .check-add button{
      height:34px;
      border:1px solid #c8cad0;
      border-radius:9px;
      background:#fff;
      padding:0 10px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      white-space:nowrap;
    }
    .check-limit{
      font-size:12px;
      font-weight:600;
      color:#6b7280;
      margin:0;
    }

    /* 복제 섹션 */
    .dup-row{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .dup-row select{
      flex:1 1 auto;
      height:34px;
      border:1px solid #cbd5e1;
      border-radius:9px;
      padding:0 10px;
      font-size:13px;
      background:rgba(255,255,255,.85);
      color:#111827;
      font-weight:500;
    }

    @media (min-width:700px){
      .week{ grid-template-columns:repeat(3,minmax(0,1fr)); }
    }
    @media (min-width:1024px){
      .week{ grid-template-columns:repeat(7,minmax(120px,1fr)); }
      .day{ min-height:200px; }
      .slot{ min-height:145px; }
    }
  </style>
</head>

<body>
<div class="app">
  <div class="panel">
    <div class="add-row">
      <input id="taskInput" type="text" placeholder="과제 이모티콘을 입력해줘" />
      <input id="noteInput" type="text" placeholder="발동 요인(Trigger)을 입력해줘" />
      <button id="addTaskBtn">+ 과제 추가</button>
    </div>
  </div>

  <div class="panel">
    <div class="week" id="week"></div>
    <div class="toolbar">
      <button id="newWeek">새로운 주차</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalBackdrop"></div>

<div class="note-pop" id="notePop">
  <div class="note-top">
    <div class="ttl" id="notePopTitle">메모</div>
    <div class="note-actions">
      <button class="note-btn" id="editBtn">수정</button>
      <button class="note-btn" id="dupBtn">복제</button>
      <button class="note-btn note-danger" id="delBtn">삭제</button>
      <button class="note-btn" id="noteCloseBtn">닫기</button>
    </div>
  </div>

  <!-- 보기 모드 -->
  <div class="note-body" id="notePopBody"></div>

  <!-- 수정 모드 -->
  <div class="edit-wrap" id="editWrap">
    <input id="editTitle" type="text" placeholder="제목" />
    <textarea id="editNote" placeholder="설명"></textarea>
    <div class="edit-actions">
      <button class="note-btn" id="editCancel">취소</button>
      <button class="note-btn" id="editSave">저장</button>
    </div>
  </div>

  <!-- 복제 모드 -->
  <div class="dup-row" id="dupRow" style="display:none;">
    <select id="dupDay">
      <option value="Sun">Sun</option><option value="Mon">Mon</option><option value="Tue">Tue</option>
      <option value="Wed">Wed</option><option value="Thu">Thu</option><option value="Fri">Fri</option>
      <option value="Sat">Sat</option>
    </select>
    <button class="note-btn" id="dupDo">생성</button>
  </div>

  <div class="check-wrap">
    <div id="checklistList" class="check-list"></div>
    <div class="check-add">
      <input id="checkInput" type="text" placeholder="수행 요소(Action)을 입력해줘" />
      <button id="checkAddBtn" type="button">추가</button>
    </div>
    <div id="checkLimitHint" class="check-limit" style="display:none;"></div>
  </div>
</div>

<script>
(() => {
  const days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  const STORAGE_KEY = "weekly-board-state-dnd-v2";

  const HOLD_TO_DRAG_MS = 420;     // ✅ hold & drag
  const CLICK_DELAY = 220;
  const MAX_CHECKLIST = 5;

  let suppressClicksUntil = 0;

  const pastelPalette = [
    { key:"p1",  bg:"#FDECEF", border:"#E7BBC6" },
    { key:"p2",  bg:"#FFF1E8", border:"#E8C3AE" },
    { key:"p3",  bg:"#FFF6E5", border:"#E9D1A2" },
    { key:"p4",  bg:"#FFFCE8", border:"#E7E1A8" },
    { key:"p5",  bg:"#EAF8F1", border:"#B8DFC8" },
    { key:"p6",  bg:"#EDF7EE", border:"#BED8C0" },
    { key:"p7",  bg:"#EAF3FF", border:"#B8CCEA" },
    { key:"p8",  bg:"#EEF0FF", border:"#C1C7EC" },
    { key:"p9",  bg:"#F1EDFF", border:"#C7BCEB" },
    { key:"p10", bg:"#FCEFF6", border:"#E5C0D6" }
  ];
  const colorMap = Object.fromEntries(pastelPalette.map(c => [c.key, c]));

  function emptyBoard(){ return Object.fromEntries(days.map(d => [d, []])); }

  let selectedDay = "Mon";
  let boardUid = 1;
  let lastColorKey = null;

  let board = emptyBoard();

  let clickTimer = null;

  // 팝오버 상태
  let popState = { day:null, uid:null };
  let popCloseTimer = null;
  let backdropCloseTimer = null;

  // 드래그 상태
  let drag = {
    active:false,
    pointerId:null,
    srcDay:null,
    uid:null,
    ghost:null,
    placeholder:null,
    overDay:null,
    overIndex:-1
  };

  const weekEl = document.getElementById("week");
  const taskInput = document.getElementById("taskInput");
  const noteInput = document.getElementById("noteInput");
  const addTaskBtn = document.getElementById("addTaskBtn");
  const newWeekBtn = document.getElementById("newWeek");

  const modalBackdrop = document.getElementById("modalBackdrop");
  const notePop = document.getElementById("notePop");
  const notePopTitle = document.getElementById("notePopTitle");
  const notePopBody = document.getElementById("notePopBody");
  const noteCloseBtn = document.getElementById("noteCloseBtn");

  const checklistList = document.getElementById("checklistList");
  const checkInput = document.getElementById("checkInput");
  const checkAddBtn = document.getElementById("checkAddBtn");
  const checkLimitHint = document.getElementById("checkLimitHint");

  const editBtn = document.getElementById("editBtn");
  const editWrap = document.getElementById("editWrap");
  const editTitle = document.getElementById("editTitle");
  const editNote = document.getElementById("editNote");
  const editCancel = document.getElementById("editCancel");
  const editSave = document.getElementById("editSave");

  const dupBtn = document.getElementById("dupBtn");
  const dupRow = document.getElementById("dupRow");
  const dupDay = document.getElementById("dupDay");
  const dupDo = document.getElementById("dupDo");

  const delBtn = document.getElementById("delBtn");

  const sanitizeLabel = s => (s || "").replace(/\s+/g, " ").trim();
  const normalizeNote = s => (s || "").replace(/\r\n/g, "\n").trim();
  const escapeHtml = s => String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#39;");

  function normalizeChecklist(list){
    if (!Array.isArray(list)) return [];
    return list.map(x => ({
      id: String(x?.id ?? ("c" + Math.random().toString(36).slice(2))),
      text: sanitizeLabel(String(x?.text ?? "")),
      done: Boolean(x?.done)
    })).filter(x => x.text);
  }

  const pillStyle = key => {
    const c = colorMap[key] || pastelPalette[0];
    return `background:${c.bg}; border-color:${c.border};`;
  };

  function randomColorKey(){
    const keys = pastelPalette.map(c => c.key);
    const pool = (lastColorKey && keys.length > 1) ? keys.filter(k => k !== lastColorKey) : keys;
    const picked = pool[Math.floor(Math.random() * pool.length)];
    lastColorKey = picked;
    return picked;
  }

  function safeLocalStorageGet(key){ try{ return localStorage.getItem(key); }catch{ return null; } }
  function safeLocalStorageSet(key, value){ try{ localStorage.setItem(key, value); }catch{} }

  function saveState(){
    const payload = {
      version: 2,
      selectedDay,
      boardUid,
      lastColorKey,
      board
    };
    safeLocalStorageSet(STORAGE_KEY, JSON.stringify(payload));
  }

  function normalizeLoadedBoard(rawBoard){
    const normalized = emptyBoard();
    if (!rawBoard || typeof rawBoard !== "object") return normalized;

    for (const day of days){
      const arr = Array.isArray(rawBoard[day]) ? rawBoard[day] : [];
      normalized[day] = arr.map(item => ({
        uid: String(item?.uid ?? "u" + Math.random().toString(36).slice(2)),
        label: sanitizeLabel(String(item?.label ?? "")),
        note: normalizeNote(String(item?.note ?? "")),
        colorKey: colorMap[item?.colorKey] ? item.colorKey : pastelPalette[0].key,
        done: Boolean(item?.done),
        checklist: normalizeChecklist(item?.checklist)
      })).filter(x => x.label);
    }
    return normalized;
  }

  function loadState(){
    const raw = safeLocalStorageGet(STORAGE_KEY);
    if (!raw) return;
    try{
      const parsed = JSON.parse(raw);
      const loadedSelected = String(parsed.selectedDay || "Mon");
      selectedDay = days.includes(loadedSelected) ? loadedSelected : "Mon";
      boardUid = Number.isFinite(parsed.boardUid) ? Math.max(1, Math.floor(parsed.boardUid)) : 1;
      lastColorKey = colorMap[parsed.lastColorKey] ? parsed.lastColorKey : null;
      board = normalizeLoadedBoard(parsed.board);
    }catch{}
  }

  function nowSuppressed(){ return Date.now() < suppressClicksUntil; }

  function findBoardItem(day, uidValue){
    const arr = board[day] || [];
    return arr.find(x => x.uid === uidValue) || null;
  }

  function hasIncompleteChecklist(item){
    const ck = Array.isArray(item.checklist) ? item.checklist : [];
    return ck.some(c => !c.done);
  }

  function toggleDone(day, uidValue){
    const item = findBoardItem(day, uidValue);
    if (!item) return false;

    if (!item.done){
      if (hasIncompleteChecklist(item)){
        alert("아직 체크리스트 남아있어. 다 체크하고 완료해줘.");
        return false;
      }
      item.done = true;
      saveState();
      return true;
    }
    item.done = false;
    saveState();
    return true;
  }

  function showBackdrop(){
    clearTimeout(backdropCloseTimer);
    modalBackdrop.style.display = "block";
    requestAnimationFrame(() => modalBackdrop.classList.add("show"));
  }
  function hideBackdrop(){
    modalBackdrop.classList.remove("show");
    clearTimeout(backdropCloseTimer);
    backdropCloseTimer = setTimeout(() => { modalBackdrop.style.display = "none"; }, 150);
  }

  function applyPopColorByKey(colorKey){
    const c = colorMap[colorKey] || pastelPalette[0];
    notePop.style.background = c.bg;
    notePop.style.borderColor = c.border;
  }
  function resetPopColor(){
    notePop.style.background = "#fff";
    notePop.style.borderColor = "#d7dce6";
  }

  function refreshChecklistControls(item){
    const ck = Array.isArray(item.checklist) ? item.checklist : [];
    const remain = MAX_CHECKLIST - ck.length;

    if (remain <= 0){
      checkAddBtn.disabled = true;
      checkInput.disabled = true;
      checkLimitHint.style.display = "block";
      checkLimitHint.textContent = "체크리스트는 최대 5개까지만 가능해.";
    }else{
      checkAddBtn.disabled = false;
      checkInput.disabled = false;
      checkLimitHint.style.display = "none";
      checkLimitHint.textContent = "";
    }
  }

  function renderChecklist(item){
    checklistList.innerHTML = "";
    const list = Array.isArray(item.checklist) ? item.checklist : [];
    const visible = list.slice(0, MAX_CHECKLIST);

    checklistList.style.display = (visible.length === 0) ? "none" : "flex";

    visible.forEach((ck, idx) => {
      const row = document.createElement("div");
      row.className = "check-item" + (ck.done ? " done" : "");
      row.innerHTML = `
        <input type="checkbox" class="check-toggle" ${ck.done ? "checked" : ""}>
        <span class="check-text">${escapeHtml(ck.text)}</span>
        <button type="button" class="check-del">×</button>
      `;

      row.querySelector(".check-toggle").addEventListener("change", (e) => {
        ck.done = e.target.checked;
        if (!ck.done && item.done) item.done = false;
        saveState();
        renderChecklist(item);
        renderWeek();
      });

      row.querySelector(".check-del").addEventListener("click", (e) => {
        e.preventDefault(); e.stopPropagation();
        list.splice(idx, 1);
        if (item.done && hasIncompleteChecklist(item)) item.done = false;
        saveState();
        renderChecklist(item);
        renderWeek();
      });

      checklistList.appendChild(row);
    });

    refreshChecklistControls(item);
  }

  function setViewMode(title, note){
    notePopTitle.textContent = title || "메모";
    const n = (note || "").trim();
    if (n){
      notePopBody.innerHTML = escapeHtml(n).replaceAll("\n","<br>");
    }else{
      notePopBody.innerHTML = `<span class="note-empty">설명이 없어</span>`;
    }
  }

  function setMode(view){
    // view | edit | dup
    if (view === "edit"){
      notePopBody.style.display = "none";
      editWrap.style.display = "flex";
      dupRow.style.display = "none";
    }else if (view === "dup"){
      notePopBody.style.display = "";
      editWrap.style.display = "none";
      dupRow.style.display = "flex";
    }else{
      notePopBody.style.display = "";
      editWrap.style.display = "none";
      dupRow.style.display = "none";
    }
  }

  function positionPopNearAnchor(anchorEl){
    const pad = 8;
    const margin = 12;

    notePop.style.left = "-9999px";
    notePop.style.top = "-9999px";
    notePop.style.display = "flex"; // gap 살리기

    const a = anchorEl.getBoundingClientRect();
    const p = notePop.getBoundingClientRect();

    let left = a.left + (a.width - p.width) / 2;
    left = Math.max(margin, Math.min(left, window.innerWidth - p.width - margin));

    let top = a.top - p.height - pad;
    if (top < margin){
      top = a.bottom + pad;
      if (top + p.height > window.innerHeight - margin){
        top = Math.max(margin, window.innerHeight - p.height - margin);
      }
    }

    notePop.style.left = `${left}px`;
    notePop.style.top = `${top}px`;
  }

  function closeNotePop(){
    if (notePop.style.display !== "flex") return;

    notePop.classList.remove("show");
    hideBackdrop();

    clearTimeout(popCloseTimer);
    popCloseTimer = setTimeout(() => {
      notePop.style.display = "none";
      popState = { day:null, uid:null };
      notePopTitle.textContent = "메모";
      notePopBody.innerHTML = "";
      checklistList.innerHTML = "";
      checklistList.style.display = "none";
      checkInput.value = "";
      resetPopColor();
      checkLimitHint.style.display = "none";
      checkLimitHint.textContent = "";
      checkAddBtn.disabled = false;
      checkInput.disabled = false;

      editTitle.value = "";
      editNote.value = "";
      setMode("view");
    }, 150);
  }

  function openNotePop(anchorEl, day, uidValue){
    const item = findBoardItem(day, uidValue);
    if (!item) return;

    popState = { day, uid:uidValue };
    applyPopColorByKey(item.colorKey);
    setViewMode(item.label, item.note || "");
    renderChecklist(item);

    editTitle.value = item.label;
    editNote.value = item.note || "";
    dupDay.value = selectedDay;

    setMode("view");
    showBackdrop();
    notePop.classList.remove("show");
    positionPopNearAnchor(anchorEl);
    requestAnimationFrame(() => notePop.classList.add("show"));
  }

  function addChecklistItem(){
    if (!popState.day || !popState.uid) return;
    const item = findBoardItem(popState.day, popState.uid);
    if (!item) return;

    const list = Array.isArray(item.checklist) ? item.checklist : (item.checklist = []);
    if (list.length >= MAX_CHECKLIST){
      alert("체크리스트는 최대 5개까지만 가능해.");
      return;
    }

    const text = sanitizeLabel(checkInput.value);
    if (!text) return;

    list.push({
      id: "c" + Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
      text,
      done:false
    });

    if (item.done) item.done = false;

    checkInput.value = "";
    saveState();
    renderChecklist(item);
    renderWeek();
  }

  function removeItem(day, uidValue){
    const arr = board[day];
    const idx = arr.findIndex(x => x.uid === uidValue);
    if (idx > -1) arr.splice(idx, 1);
    if (popState.uid === uidValue && popState.day === day) closeNotePop();
    saveState();
  }

  /* ✅ 복제: 체크리스트 포함(텍스트 유지), 체크 상태는 모두 false로 리셋 / 색상은 랜덤 */
  function duplicateItem(toDay){
    const { day, uid } = popState;
    if (!day || !uid) return;
    const item = findBoardItem(day, uid);
    if (!item) return;

    const srcCk = Array.isArray(item.checklist) ? item.checklist : [];
    const newChecklist = srcCk.map(c => ({
      id: "c" + Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
      text: c.text,
      done: false
    }));

    board[toDay].push({
      uid: "u" + (boardUid++),
      label: item.label,
      note: item.note,
      colorKey: randomColorKey(),   // ✅ 랜덤 재지정
      done:false,
      checklist: newChecklist        // ✅ 포함
    });

    selectedDay = toDay;
    saveState();
    renderWeek();
  }

  function saveEdits(){
    const { day, uid } = popState;
    if (!day || !uid) return;
    const item = findBoardItem(day, uid);
    if (!item) return;

    const newTitle = sanitizeLabel(editTitle.value);
    const newNote = normalizeNote(editNote.value);

    if (!newTitle){
      alert("제목은 비워둘 수 없어.");
      return;
    }

    item.label = newTitle;
    item.note = newNote;

    saveState();
    setViewMode(item.label, item.note || "");
    renderWeek();
    setMode("view");
  }

  /* ===== Hold & Drag ===== */
  function startDrag(chipEl, day, uid, e){
    drag.active = true;
    drag.pointerId = e.pointerId;
    drag.srcDay = day;
    drag.uid = uid;

    const ph = document.createElement("div");
    ph.className = "drag-placeholder";
    drag.placeholder = ph;
    chipEl.parentNode.insertBefore(ph, chipEl.nextSibling);

    const ghost = chipEl.cloneNode(true);
    ghost.classList.add("drag-ghost");
    document.body.appendChild(ghost);
    drag.ghost = ghost;

    moveGhost(e.clientX, e.clientY);

    chipEl.style.visibility = "hidden";
    chipEl.setPointerCapture(e.pointerId);

    suppressClicksUntil = Date.now() + 450;
  }

  function moveGhost(x, y){
    if (!drag.ghost) return;
    drag.ghost.style.left = x + "px";
    drag.ghost.style.top = y + "px";
  }

  function findDropTarget(x, y){
    const el = document.elementFromPoint(x, y);
    if (!el) return null;

    const slot = el.closest(".slot");
    if (!slot) return null;

    const dayEl = slot.closest(".day");
    const day = dayEl?.dataset?.day;
    if (!day) return null;

    const chips = Array.from(slot.querySelectorAll(".chip")).filter(c => c.style.visibility !== "hidden");
    let idx = chips.length;

    for (let i = 0; i < chips.length; i++){
      const r = chips[i].getBoundingClientRect();
      const sameRow = Math.abs((r.top + r.height/2) - y) < 26;
      const mid = r.left + r.width / 2;

      if (sameRow && x < mid){ idx = i; break; }
      if (y < r.top + r.height/2){ idx = i; break; }
    }

    return { day, slot, idx };
  }

  function placePlaceholder(target){
    if (!drag.placeholder) return;
    const slot = target.slot;
    const nodes = Array.from(slot.children).filter(n => n !== drag.placeholder);
    const before = nodes[target.idx] || null;
    slot.insertBefore(drag.placeholder, before);
    drag.overDay = target.day;
    drag.overIndex = target.idx;
  }

  function cleanupDrag(){
    drag.active = false;
    drag.pointerId = null;

    if (drag.ghost && drag.ghost.parentNode) drag.ghost.parentNode.removeChild(drag.ghost);
    drag.ghost = null;

    if (drag.placeholder && drag.placeholder.parentNode) drag.placeholder.parentNode.removeChild(drag.placeholder);
    drag.placeholder = null;

    drag.overDay = null;
    drag.overIndex = -1;
    drag.srcDay = null;
    drag.uid = null;
  }

  function finishDrag(){
    if (!drag.active) return;

    const hiddenChip = document.querySelector(`.chip[data-uid="${drag.uid}"][data-day="${drag.srcDay}"]`);
    if (hiddenChip) hiddenChip.style.visibility = "";

    const fromDay = drag.srcDay;
    const toDay = drag.overDay ?? fromDay;
    let toIndex = drag.overIndex;
    if (!Number.isFinite(toIndex) || toIndex < 0) toIndex = (board[toDay] || []).length;

    const srcArr = board[fromDay] || [];
    const srcIdx = srcArr.findIndex(x => x.uid === drag.uid);
    if (srcIdx === -1){
      cleanupDrag();
      renderWeek();
      return;
    }

    const [item] = srcArr.splice(srcIdx, 1);
    const dstArr = board[toDay] || (board[toDay] = []);

    if (fromDay === toDay && srcIdx < toIndex) toIndex = Math.max(0, toIndex - 1);
    toIndex = Math.min(dstArr.length, Math.max(0, toIndex));
    dstArr.splice(toIndex, 0, item);

    selectedDay = toDay;
    saveState();
    cleanupDrag();
    renderWeek();
  }

  function cancelDrag(){
    if (!drag.active) return;
    const hiddenChip = document.querySelector(`.chip[data-uid="${drag.uid}"][data-day="${drag.srcDay}"]`);
    if (hiddenChip) hiddenChip.style.visibility = "";
    cleanupDrag();
    renderWeek();
  }

  function addTask(){
    const label = sanitizeLabel(taskInput.value);
    if (!label) return;

    const note = normalizeNote(noteInput.value);
    const colorKey = randomColorKey();

    board[selectedDay].push({
      uid: "u" + (boardUid++),
      label,
      note,
      colorKey,
      done:false,
      checklist:[]
    });

    taskInput.value = "";
    noteInput.value = "";
    saveState();
    renderWeek();
  }

  function renderWeek(){
    weekEl.innerHTML = "";

    days.forEach(day => {
      const col = document.createElement("div");
      col.className = "day" + (day === selectedDay ? " selected" : "");
      col.dataset.day = day;

      const head = document.createElement("div");
      head.className = "day-head";
      head.textContent = day;
      head.onclick = () => {
        if (nowSuppressed()) return;
        selectedDay = day;
        saveState();
        renderWeek();
      };

      const slot = document.createElement("div");
      slot.className = "slot";
      slot.onclick = () => {
        if (nowSuppressed()) return;
        selectedDay = day;
        saveState();
        renderWeek();
      };

      (board[day] || []).forEach((item) => {
        const ckLen = Array.isArray(item.checklist) ? item.checklist.length : 0;

        const chip = document.createElement("div");
        chip.className = "chip item" + (item.done ? " done" : "") + (ckLen ? " has-ck" : "");
        chip.dataset.uid = item.uid;
        chip.dataset.day = day;

        if (!item.done) chip.style.cssText = pillStyle(item.colorKey);

        chip.innerHTML = `
          <span class="chip-text" title="${escapeHtml(item.label)}">${escapeHtml(item.label)}</span>
          <span class="ck-count">${ckLen}</span>
        `;

        /* ✅ hold & drag: 길게 누르면 드래그 시작 */
        let holdTimer = null;
        let holding = false;

        const clearHold = () => {
          if (holdTimer){ clearTimeout(holdTimer); holdTimer = null; }
          holding = false;
        };

        chip.addEventListener("pointerdown", (e) => {
          if (nowSuppressed()) return;
          if (drag.active) return;
          if (e.button !== undefined && e.button !== 0) return;

          holding = true;
          const startX = e.clientX, startY = e.clientY;

          holdTimer = setTimeout(() => {
            if (!holding) return;
            startDrag(chip, day, item.uid, e);
          }, HOLD_TO_DRAG_MS);

          const moveHandler = (ev) => {
            if (!holding || !holdTimer) return;
            const dx = Math.abs(ev.clientX - startX);
            const dy = Math.abs(ev.clientY - startY);
            if (dx + dy > 12){
              // 스크롤/실수 이동이면 hold 취소
              clearHold();
            }
          };

          const upHandler = () => { clearHold(); cleanup(); };
          const cancelHandler = () => { clearHold(); cleanup(); };

          const cleanup = () => {
            window.removeEventListener("pointermove", moveHandler);
            window.removeEventListener("pointerup", upHandler);
            window.removeEventListener("pointercancel", cancelHandler);
          };

          window.addEventListener("pointermove", moveHandler, { passive:true });
          window.addEventListener("pointerup", upHandler, { passive:true });
          window.addEventListener("pointercancel", cancelHandler, { passive:true });
        });

        /* 클릭: 팝오버 / 더블클릭: 완료 (드래그 중이면 무시) */
        chip.addEventListener("click", (e) => {
          if (drag.active) return;
          if (nowSuppressed()) return;

          e.stopPropagation();
          selectedDay = day;
          saveState();

          clearTimeout(clickTimer);
          clickTimer = setTimeout(() => {
            openNotePop(chip, day, item.uid);
          }, CLICK_DELAY);
        });

        chip.addEventListener("dblclick", (e) => {
          if (drag.active) return;
          if (nowSuppressed()) return;
          e.preventDefault();
          e.stopPropagation();
          clearTimeout(clickTimer);

          if (toggleDone(day, item.uid)){
            renderWeek();
          }
        });

        slot.appendChild(chip);
      });

      col.appendChild(head);
      col.appendChild(slot);
      weekEl.appendChild(col);
    });
  }

  /* 전역 드래그 핸들 */
  document.addEventListener("pointermove", (e) => {
    if (!drag.active) return;
    if (drag.pointerId !== null && e.pointerId !== drag.pointerId) return;

    moveGhost(e.clientX, e.clientY);
    const t = findDropTarget(e.clientX, e.clientY);
    if (t) placePlaceholder(t);
  }, { passive:true });

  document.addEventListener("pointerup", (e) => {
    if (!drag.active) return;
    if (drag.pointerId !== null && e.pointerId !== drag.pointerId) return;
    finishDrag();
  });

  document.addEventListener("pointercancel", (e) => {
    if (!drag.active) return;
    if (drag.pointerId !== null && e.pointerId !== drag.pointerId) return;
    cancelDrag();
  });

  /* 팝오버 밖 클릭 닫기 */
  document.addEventListener("click", (e) => {
    const inPop = notePop.contains(e.target);
    const onChip = e.target.closest && e.target.closest(".chip");
    if (!inPop && notePop.style.display === "flex" && !onChip){
      closeNotePop();
    }
  });

  /* 모바일 키보드 리사이즈 대응: 가로 변화일 때만 닫기 */
  let lastW = window.innerWidth;
  window.addEventListener("resize", () => {
    const w = window.innerWidth;
    const widthChanged = Math.abs(w - lastW) > 30;
    lastW = w;
    if (widthChanged && notePop.style.display === "flex") closeNotePop();
  });

  /* 버튼/입력 */
  addTaskBtn.onclick = addTask;
  taskInput.addEventListener("keydown", (e) => { if (e.key === "Enter") addTask(); });
  noteInput.addEventListener("keydown", (e) => { if (e.key === "Enter") addTask(); });

  noteCloseBtn.onclick = closeNotePop;
  modalBackdrop.onclick = closeNotePop;

  checkAddBtn.onclick = addChecklistItem;
  checkInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter"){
      e.preventDefault();
      addChecklistItem();
    }
  });

  /* 팝오버: 수정/복제/삭제 */
  editBtn.onclick = () => setMode("edit");
  editCancel.onclick = () => {
    const item = findBoardItem(popState.day, popState.uid);
    if (item){
      editTitle.value = item.label;
      editNote.value = item.note || "";
    }
    setMode("view");
  };
  editSave.onclick = saveEdits;

  dupBtn.onclick = () => {
    dupDay.value = selectedDay;
    setMode("dup");
  };
  dupDo.onclick = () => {
    const d = dupDay.value;
    if (!days.includes(d)) return;
    duplicateItem(d);
    setMode("view");
  };

  delBtn.onclick = () => {
    const { day, uid } = popState;
    if (!day || !uid) return;
    if (!confirm("이 탭 지울까?")) return;
    removeItem(day, uid);
    closeNotePop();
    renderWeek();
  };

  /* 새로운 주차 */
  newWeekBtn.onclick = () => {
    if (!confirm("새로운 주차로 넘어갈까? 지금 배치 다 비워져.")) return;
    board = emptyBoard();
    selectedDay = "Mon";
    closeNotePop();
    saveState();
    renderWeek();
    alert("새로운 주차로 초기화했어.");
  };

  loadState();
  renderWeek();
})();
</script>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try {
        const reg = await navigator.serviceWorker.register("./sw.js?v=21");
        reg.update();
      } catch (err) {
        console.log("SW register failed:", err);
      }
    });
  }
</script>
</body>
</html>
