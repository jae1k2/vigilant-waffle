<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>주간 블록 보드</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">

  <style>
    :root{
      --bg:#ffffff;
      --card:#f7f7f8;
      --line:#d9d9de;
      --text:#1f2328;
      --done-bg:#eef0f3;
      --done-border:#c9ced6;
      --done-text:#6f7782;
      --radius:14px;
    }

    *{
      box-sizing:border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
    }

    .app{
      max-width:1080px;
      margin:0 auto;
      padding:12px;
    }

    .panel{
      border:1.5px solid var(--line);
      border-radius:var(--radius);
      background:var(--card);
      padding:10px;
      margin-bottom:12px;
    }

    .add-row{
      display:flex;
      gap:8px;
      margin-bottom:10px;
      flex-wrap:wrap;
      align-items:stretch;
    }

    .add-row input{
      border:1px solid #c8cad0;
      border-radius:10px;
      height:38px;
      padding:0 12px;
      font-size:14px;
      background:#fff;
      color:#111827;
      font-weight:600;
    }

    #taskInput{
      flex:1 1 260px;
      min-width:170px;
      color:#111827;
    }

    #noteInput{
      flex:1 1 380px;
      min-width:220px;
      color:#2f3a4a;
      font-weight:500;
    }

    .add-row input::placeholder{
      color:#9aa3b2;
      font-weight:500;
    }

    .add-row button{
      border:1px solid #c8cad0;
      background:#fff;
      border-radius:10px;
      height:38px;
      padding:0 12px;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
    }

    .storage{
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding:2px 1px 4px;
      min-height:46px;
      align-items:center;
    }

    .template{
      height:42px;
      min-width:52px;
      max-width:260px;
      border:1px solid #b8bbc2;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:0 10px 0 12px;
      font-weight:700;
      font-size:14px;
      flex:0 0 auto;
      user-select:none;
      cursor:pointer;
    }

    .task-text{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:170px;
    }

    .mini-del{
      width:20px;
      height:20px;
      border:1px solid #c8cad0;
      border-radius:50%;
      display:grid;
      place-items:center;
      font-size:12px;
      color:#6c7280;
      background:#fff;
      line-height:1;
      padding:0;
      cursor:pointer;
    }

    .week{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }

    .day{
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      min-height:120px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      transition:.15s;
    }

    .day.selected{
      border:1px solid var(--line);
      background:#fff;
      box-shadow:none;
    }

    .day-head{
      padding:8px 10px;
      font-weight:400;
      font-size:14px;
      border-bottom:1px solid #ececf0;
      background:#fafafa;
      display:flex;
      justify-content:flex-start;
      cursor:pointer;
      transition:background .15s, border-bottom-color .15s;
    }

    .day.selected .day-head{
      background:#eaf3ff;
      border-bottom-color:#d7e6ff;
    }

    .slot{
      padding:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-content:flex-start;
      min-height:84px;
      cursor:pointer;
    }

    .item{
      height:42px;
      min-width:42px;
      max-width:260px;
      padding:0 10px 0 12px;
      border:1px solid #b8bbc2;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      font-size:14px;
      user-select:none;
      touch-action:none;
      position:relative;
      transition:background .18s, border-color .18s, color .18s, transform .08s;
    }

    .item:active{ transform:scale(.99); }

    .item-text{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:170px;
    }

    .del{
      width:22px;
      height:22px;
      border:1px solid #c8cad0;
      border-radius:50%;
      display:grid;
      place-items:center;
      font-size:13px;
      color:#6c7280;
      background:#fff;
      cursor:pointer;
      line-height:1;
      padding:0;
    }

    .item.done{
      background:var(--done-bg) !important;
      border-color:var(--done-border) !important;
      color:var(--done-text);
    }

    .item.done .item-text{
      text-decoration:line-through;
      text-decoration-thickness:1.5px;
      opacity:.9;
    }

    .toolbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .toolbar button{
      border:1px solid #c8cad0;
      background:#fff;
      border-radius:10px;
      height:38px;
      padding:0 12px;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(255,255,255,0.01);
      backdrop-filter:blur(4px);
      -webkit-backdrop-filter:blur(4px);
      opacity:0;
      display:none;
      z-index:50;
      transition:opacity .14s ease;
    }

    .modal-backdrop.show{ opacity:1; }

    .note-pop{
      position:fixed;
      z-index:60;
      width:min(250px, calc(100vw - 24px));
      min-height:220px;
      max-height:calc(100vh - 24px);
      overflow:auto;
      background:#fff;
      border:1px solid #d7dce6;
      border-radius:12px;
      box-shadow:0 14px 34px rgba(16,24,40,.18);
      padding:12px;
      display:none;
      opacity:0;
      transform:translateY(6px);
      transition:opacity .14s ease, transform .14s ease;
      will-change:opacity, transform;
    }

    .note-pop.show{
      opacity:1;
      transform:translateY(0);
    }

    .note-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }

    .note-top .ttl{
      font-size:16px;
      font-weight:800;
      color:#2f3a4a;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      line-height:1.25;
    }

    .note-actions{ display:flex; gap:6px; }

    .note-btn{
      border:1px solid #cfd5df;
      background:#fff;
      color:#364152;
      border-radius:8px;
      height:28px;
      padding:0 9px;
      font-size:12px;
      font-weight:700;
      cursor:pointer;
    }

    .note-btn.primary{
      border-color:#9bb6ff;
      color:#1f4ed8;
      background:#f3f7ff;
    }

    .note-body{
      font-size:13px;
      line-height:1.62;
      color:#1f2937;
      white-space:pre-wrap;
      word-break:break-word;
      padding-left:14px;
      margin-left:2px;
    }

    .note-empty{
      color:#8a93a2;
      font-style:italic;
    }

    .note-editor{
      width:100%;
      min-height:120px;
      max-height:60vh;
      resize:none;
      overflow-y:hidden;
      border:1px solid #ccd3df;
      border-radius:10px;
      padding:10px;
      font-size:13px;
      line-height:1.45;
      font-family:inherit;
      background:rgba(255,255,255,.9);
    }

    @media (min-width:700px){
      .week{ grid-template-columns:repeat(3,minmax(0,1fr)); }
    }

    @media (min-width:1024px){
      .week{ grid-template-columns:repeat(7,minmax(120px,1fr)); }
      .day{ min-height:200px; }
      .slot{ min-height:145px; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="panel">
    <div class="add-row">
      <input id="taskInput" type="text" placeholder="여기에 과제를 입력해" />
      <input id="noteInput" type="text" placeholder="여기에는 설명을 입력해줘" />
      <button id="addTaskBtn">+ 과제 추가</button>
    </div>
    <div class="storage" id="storage"></div>
  </div>

  <div class="panel">
    <div class="week" id="week"></div>
    <div class="toolbar">
      <button id="newWeek">새로운 주차</button>
      <button id="showSummary">배치 요약 보기</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalBackdrop"></div>

<div class="note-pop" id="notePop">
  <div class="note-top">
    <div class="ttl" id="notePopTitle">메모</div>
    <div class="note-actions" id="noteActionsView">
      <button class="note-btn" id="noteEditBtn">수정</button>
      <button class="note-btn" id="noteCloseBtn">닫기</button>
    </div>
    <div class="note-actions" id="noteActionsEdit" style="display:none;">
      <button class="note-btn primary" id="noteSaveBtn">저장</button>
      <button class="note-btn" id="noteCancelBtn">취소</button>
    </div>
  </div>
  <div class="note-body" id="notePopBody"></div>
</div>

<script>
(() => {
  const days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  const LONG_PRESS_MS = 420;
  const CLICK_DELAY = 220;
  const STORAGE_KEY = "weekly-board-state-v3";

  const pastelPalette = [
    { key:"p1",  name:"Blush",   bg:"#FDECEF", border:"#E7BBC6" },
    { key:"p2",  name:"Peach",   bg:"#FFF1E8", border:"#E8C3AE" },
    { key:"p3",  name:"Apricot", bg:"#FFF6E5", border:"#E9D1A2" },
    { key:"p4",  name:"Lemon",   bg:"#FFFCE8", border:"#E7E1A8" },
    { key:"p5",  name:"Mint",    bg:"#EAF8F1", border:"#B8DFC8" },
    { key:"p6",  name:"Sage",    bg:"#EDF7EE", border:"#BED8C0" },
    { key:"p7",  name:"Sky",     bg:"#EAF3FF", border:"#B8CCEA" },
    { key:"p8",  name:"Peri",    bg:"#EEF0FF", border:"#C1C7EC" },
    { key:"p9",  name:"Lav",     bg:"#F1EDFF", border:"#C7BCEB" },
    { key:"p10", name:"Rose",    bg:"#FCEFF6", border:"#E5C0D6" }
  ];
  const colorMap = Object.fromEntries(pastelPalette.map(c => [c.key, c]));

  function emptyBoard() {
    return Object.fromEntries(days.map(d => [d, []]));
  }

  let selectedDay = "Mon";
  let boardUid = 1;
  let taskUid = 1;
  let lastColorKey = null;
  let tasks = [];
  let board = emptyBoard();

  const weekEl = document.getElementById("week");
  const storageEl = document.getElementById("storage");
  const taskInput = document.getElementById("taskInput");
  const noteInput = document.getElementById("noteInput");
  const addTaskBtn = document.getElementById("addTaskBtn");
  const newWeekBtn = document.getElementById("newWeek");
  const showSummaryBtn = document.getElementById("showSummary");

  const modalBackdrop = document.getElementById("modalBackdrop");
  const notePop = document.getElementById("notePop");
  const notePopTitle = document.getElementById("notePopTitle");
  const notePopBody = document.getElementById("notePopBody");
  const noteActionsView = document.getElementById("noteActionsView");
  const noteActionsEdit = document.getElementById("noteActionsEdit");
  const noteEditBtn = document.getElementById("noteEditBtn");
  const noteCloseBtn = document.getElementById("noteCloseBtn");
  const noteSaveBtn = document.getElementById("noteSaveBtn");
  const noteCancelBtn = document.getElementById("noteCancelBtn");

  let popState = { day:null, uid:null, isEdit:false };
  let clickTimer = null;
  let popCloseTimer = null;
  let backdropCloseTimer = null;

  const sanitizeLabel = s => (s || "").replace(/\s+/g, " ").trim();
  const normalizeNote = s => (s || "").replace(/\r\n/g, "\n").trim();
  const escapeHtml = s => String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");

  const pillStyle = key => {
    const c = colorMap[key] || pastelPalette[0];
    return `background:${c.bg}; border-color:${c.border};`;
  };

  function randomColorKey(){
    const keys = pastelPalette.map(c => c.key);
    const pool = (lastColorKey && keys.length > 1)
      ? keys.filter(k => k !== lastColorKey)
      : keys;
    const picked = pool[Math.floor(Math.random() * pool.length)];
    lastColorKey = picked;
    return picked;
  }

  function safeLocalStorageGet(key){
    try { return localStorage.getItem(key); } catch { return null; }
  }
  function safeLocalStorageSet(key, value){
    try { localStorage.setItem(key, value); } catch {}
  }

  function saveState(){
    const payload = {
      version: 3,
      selectedDay,
      boardUid,
      taskUid,
      lastColorKey,
      tasks,
      board
    };
    safeLocalStorageSet(STORAGE_KEY, JSON.stringify(payload));
  }

  function normalizeLoadedBoard(rawBoard){
    const normalized = emptyBoard();
    if (!rawBoard || typeof rawBoard !== "object") return normalized;

    for (const day of days){
      const arr = Array.isArray(rawBoard[day]) ? rawBoard[day] : [];
      normalized[day] = arr.map(item => ({
        uid: String(item?.uid ?? "u" + Math.random().toString(36).slice(2)),
        sourceTid: item?.sourceTid ? String(item.sourceTid) : null,
        label: sanitizeLabel(String(item?.label ?? "")),
        note: normalizeNote(String(item?.note ?? "")),
        colorKey: colorMap[item?.colorKey] ? item.colorKey : pastelPalette[0].key,
        done: Boolean(item?.done)
      })).filter(x => x.label);
    }
    return normalized;
  }

  function loadState(){
    const raw = safeLocalStorageGet(STORAGE_KEY);
    if (!raw) return;

    try{
      const parsed = JSON.parse(raw);
      if (!parsed || typeof parsed !== "object") return;

      const loadedSelected = String(parsed.selectedDay || "Mon");
      selectedDay = days.includes(loadedSelected) ? loadedSelected : "Mon";

      boardUid = Number.isFinite(parsed.boardUid) ? Math.max(1, Math.floor(parsed.boardUid)) : 1;
      taskUid = Number.isFinite(parsed.taskUid) ? Math.max(1, Math.floor(parsed.taskUid)) : 1;

      lastColorKey = colorMap[parsed.lastColorKey] ? parsed.lastColorKey : null;

      const loadedTasks = Array.isArray(parsed.tasks) ? parsed.tasks : [];
      tasks = loadedTasks.map(t => ({
        tid: String(t?.tid ?? "t" + Math.random().toString(36).slice(2)),
        label: sanitizeLabel(String(t?.label ?? "")),
        note: normalizeNote(String(t?.note ?? "")),
        colorKey: colorMap[t?.colorKey] ? t.colorKey : pastelPalette[0].key
      })).filter(t => t.label);

      board = normalizeLoadedBoard(parsed.board);

      let maxBoardUid = 0;
      for (const d of days){
        for (const item of board[d]){
          const m = String(item.uid).match(/^u(\d+)$/);
          if (m) maxBoardUid = Math.max(maxBoardUid, Number(m[1]));
        }
      }
      boardUid = Math.max(boardUid, maxBoardUid + 1);

      let maxTaskUid = 0;
      for (const t of tasks){
        const m = String(t.tid).match(/^t(\d+)$/);
        if (m) maxTaskUid = Math.max(maxTaskUid, Number(m[1]));
      }
      taskUid = Math.max(taskUid, maxTaskUid + 1);

    }catch{
    }
  }

  function applyPopColorByKey(colorKey){
    const c = colorMap[colorKey] || pastelPalette[0];
    notePop.style.background = c.bg;
    notePop.style.borderColor = c.border;
  }

  function resetPopColor(){
    notePop.style.background = "#fff";
    notePop.style.borderColor = "#d7dce6";
  }

  function showBackdrop(){
    clearTimeout(backdropCloseTimer);
    modalBackdrop.style.display = "block";
    requestAnimationFrame(() => modalBackdrop.classList.add("show"));
  }

  function hideBackdrop(){
    modalBackdrop.classList.remove("show");
    clearTimeout(backdropCloseTimer);
    backdropCloseTimer = setTimeout(() => {
      modalBackdrop.style.display = "none";
    }, 150);
  }

  function vibrateTick(){
    try{
      if (navigator && typeof navigator.vibrate === "function") navigator.vibrate(20);
    }catch{}
  }

  function findBoardItem(day, uidValue){
    const arr = board[day] || [];
    return arr.find(x => x.uid === uidValue) || null;
  }

  function fitPopWithinViewport(){
    if (notePop.style.display !== "block") return;

    const margin = 12;
    const rect = notePop.getBoundingClientRect();

    let left = parseFloat(notePop.style.left || "0");
    let top = parseFloat(notePop.style.top || "0");

    if (rect.right > window.innerWidth - margin){
      left -= (rect.right - (window.innerWidth - margin));
    }
    if (left < margin) left = margin;

    if (rect.bottom > window.innerHeight - margin){
      top -= (rect.bottom - (window.innerHeight - margin));
    }
    if (top < margin) top = margin;

    notePop.style.left = `${left}px`;
    notePop.style.top = `${top}px`;
  }

  function refreshPopoverLayout(){
    if (notePop.style.display !== "block") return;

    notePop.style.height = "auto";
    const maxPx = window.innerHeight - 24;
    const desired = Math.min(notePop.scrollHeight, maxPx);

    notePop.style.height = `${desired}px`;
    notePop.style.overflowY = notePop.scrollHeight > maxPx ? "auto" : "hidden";

    fitPopWithinViewport();
  }

  function autoResizeNoteEditor(){
    const ed = document.getElementById("noteEditor");
    if (!ed) return;

    ed.style.height = "auto";
    const maxPx = Math.floor(window.innerHeight * 0.60);
    const desired = Math.min(ed.scrollHeight, maxPx);

    ed.style.height = `${desired}px`;
    ed.style.overflowY = ed.scrollHeight > maxPx ? "auto" : "hidden";

    refreshPopoverLayout();
  }

  function closeNotePop(){
    if (notePop.style.display !== "block") return;

    notePop.classList.remove("show");
    hideBackdrop();

    clearTimeout(popCloseTimer);
    popCloseTimer = setTimeout(() => {
      notePop.style.display = "none";
      notePop.style.height = "auto";
      notePop.style.overflowY = "auto";
      popState = { day:null, uid:null, isEdit:false };
      notePopBody.innerHTML = "";
      noteActionsView.style.display = "";
      noteActionsEdit.style.display = "none";
      resetPopColor();
    }, 150);
  }

  function setViewMode(title, note){
    popState.isEdit = false;
    notePopTitle.textContent = title || "메모";
    notePopBody.innerHTML = note
      ? escapeHtml(note).replaceAll("\n","<br>")
      : '<span class="note-empty">상세 내용이 비어 있어요.</span>';
    noteActionsView.style.display = "";
    noteActionsEdit.style.display = "none";
  }

  function setEditMode(title, note){
    popState.isEdit = true;
    notePopTitle.textContent = title || "메모 수정";
    notePopBody.innerHTML = `<textarea class="note-editor" id="noteEditor"></textarea>`;

    const ed = document.getElementById("noteEditor");
    ed.value = note || "";
    noteActionsView.style.display = "none";
    noteActionsEdit.style.display = "";

    ed.addEventListener("input", autoResizeNoteEditor);

    setTimeout(() => {
      autoResizeNoteEditor();
      ed.focus();
      ed.selectionStart = ed.selectionEnd = ed.value.length;
    }, 0);
  }

  function positionPopNearAnchor(anchorEl){
    const pad = 8;
    const margin = 12;

    notePop.style.left = "-9999px";
    notePop.style.top = "-9999px";
    notePop.style.display = "block";

    const a = anchorEl.getBoundingClientRect();
    const p = notePop.getBoundingClientRect();

    let left = a.left + (a.width - p.width) / 2;
    left = Math.max(margin, Math.min(left, window.innerWidth - p.width - margin));

    let top = a.top - p.height - pad;
    if (top < margin){
      top = a.bottom + pad;
      if (top + p.height > window.innerHeight - margin){
        top = Math.max(margin, window.innerHeight - p.height - margin);
      }
    }

    notePop.style.left = `${left}px`;
    notePop.style.top = `${top}px`;
  }

  function openNotePop(anchorEl, day, uidValue){
    const item = findBoardItem(day, uidValue);
    if (!item) return;

    clearTimeout(popCloseTimer);
    popState = { day, uid:uidValue, isEdit:false };

    applyPopColorByKey(item.colorKey);
    setViewMode(item.label, item.note || "");
    showBackdrop();

    notePop.classList.remove("show");
    positionPopNearAnchor(anchorEl);

    requestAnimationFrame(() => {
      notePop.classList.add("show");
      refreshPopoverLayout();
    });
  }

  function toggleDone(day, uidValue){
    const item = findBoardItem(day, uidValue);
    if (!item) return;
    item.done = !item.done;
    saveState();
  }

  function addTask(){
    const label = sanitizeLabel(taskInput.value);
    if (!label) return;

    const note = normalizeNote(noteInput.value);
    const colorKey = randomColorKey();

    const taskObj = {
      tid: "t" + (taskUid++),
      label,
      note,
      colorKey
    };

    tasks.push(taskObj);
    taskInput.value = "";
    noteInput.value = "";

    saveState();
    renderStorage();
  }

  function deleteTaskFromStorage(taskObj){
    tasks = tasks.filter(t => t.tid !== taskObj.tid);

    for (const d of days){
      board[d] = board[d].filter(i => i.sourceTid !== taskObj.tid);
    }

    closeNotePop();
    saveState();
    renderAll();
  }

  function removeItem(day, uidValue){
    const arr = board[day];
    const idx = arr.findIndex(x => x.uid === uidValue);
    if (idx > -1) arr.splice(idx, 1);
    if (popState.uid === uidValue && popState.day === day) closeNotePop();

    saveState();
  }

  function renderStorage(){
    storageEl.innerHTML = "";

    if (!tasks.length){
      const empty = document.createElement("div");
      empty.style.fontSize = "13px";
      empty.style.color = "#666b74";
      empty.textContent = "아직 과제가 없어. 위에서 추가해줘.";
      storageEl.appendChild(empty);
      return;
    }

    tasks.forEach(taskObj => {
      const pill = document.createElement("div");
      pill.className = "template";
      pill.style.cssText = pillStyle(taskObj.colorKey);
      pill.innerHTML = `
        <span class="task-text" title="${escapeHtml(taskObj.label)}">${escapeHtml(taskObj.label)}</span>
        <button type="button" class="mini-del">×</button>
      `;

      pill.onclick = (e) => {
        if (e.target.closest(".mini-del")) return;

        board[selectedDay].push({
          uid: "u" + (boardUid++),
          sourceTid: taskObj.tid,
          label: taskObj.label,
          note: taskObj.note,
          colorKey: taskObj.colorKey,
          done:false
        });

        saveState();
        renderWeek();
      };

      const miniDel = pill.querySelector(".mini-del");
      const hardDelete = (e) => {
        e.preventDefault();
        e.stopPropagation();
        deleteTaskFromStorage(taskObj);
      };

      miniDel.addEventListener("mousedown", hardDelete);
      miniDel.addEventListener("pointerdown", hardDelete);
      miniDel.addEventListener("click", hardDelete);

      storageEl.appendChild(pill);
    });
  }

  function attachPressHandlers(chip, day, item){
    let longPressTimer = null;
    let longPressFired = false;
    let startX = 0, startY = 0;

    const clearPress = () => {
      if (longPressTimer){
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
    };

    chip.addEventListener("pointerdown", (e) => {
      if (e.target.closest(".del")) return;
      longPressFired = false;
      startX = e.clientX;
      startY = e.clientY;

      clearPress();
      longPressTimer = setTimeout(() => {
        longPressFired = true;
        clearTimeout(clickTimer);
        toggleDone(day, item.uid);
        vibrateTick();
        renderWeek();
      }, LONG_PRESS_MS);
    });

    chip.addEventListener("pointermove", (e) => {
      if (!longPressTimer) return;
      const dx = Math.abs(e.clientX - startX);
      const dy = Math.abs(e.clientY - startY);
      if (dx > 8 || dy > 8) clearPress();
    });

    chip.addEventListener("pointerup", () => {
      clearPress();
      if (longPressFired){
        chip.dataset.longpressed = "1";
        setTimeout(() => { chip.dataset.longpressed = "0"; }, 140);
      }
    });

    chip.addEventListener("pointercancel", clearPress);
    chip.addEventListener("mouseleave", clearPress);
  }

  function renderWeek(){
    weekEl.innerHTML = "";

    days.forEach(day => {
      const col = document.createElement("div");
      col.className = "day" + (day === selectedDay ? " selected" : "");

      const head = document.createElement("div");
      head.className = "day-head";
      head.innerHTML = `<span>${day}</span>`;
      head.onclick = () => {
        selectedDay = day;
        saveState();
        renderWeek();
      };

      const slot = document.createElement("div");
      slot.className = "slot";
      slot.onclick = () => {
        selectedDay = day;
        saveState();
        renderWeek();
      };

      board[day].forEach(item => {
        const chip = document.createElement("div");
        chip.className = "item" + (item.done ? " done" : "");
        chip.dataset.uid = item.uid;
        chip.dataset.day = day;
        chip.dataset.longpressed = "0";

        if (!item.done) chip.style.cssText = pillStyle(item.colorKey);

        chip.innerHTML = `
          <span class="item-text" title="${escapeHtml(item.label)}">${escapeHtml(item.label)}</span>
          <button type="button" class="del">×</button>
        `;

        const delBtn = chip.querySelector(".del");
        const hardDelete = (e) => {
          e.preventDefault();
          e.stopPropagation();
          removeItem(day, item.uid);
          renderWeek();
        };
        delBtn.addEventListener("mousedown", hardDelete);
        delBtn.addEventListener("pointerdown", hardDelete);
        delBtn.addEventListener("click", hardDelete);

        attachPressHandlers(chip, day, item);

        chip.addEventListener("click", (e) => {
          if (e.target.closest(".del")) return;
          if (chip.dataset.longpressed === "1") return;
          e.stopPropagation();

          selectedDay = day;
          saveState();

          clearTimeout(clickTimer);
          clickTimer = setTimeout(() => {
            openNotePop(chip, day, item.uid);
          }, CLICK_DELAY);
        });

        chip.addEventListener("dblclick", (e) => {
          if (e.target.closest(".del")) return;
          e.preventDefault();
          e.stopPropagation();
          clearTimeout(clickTimer);
          toggleDone(day, item.uid);
          vibrateTick();
          renderWeek();
        });

        slot.appendChild(chip);
      });

      col.appendChild(head);
      col.appendChild(slot);
      weekEl.appendChild(col);
    });
  }

  function renderAll(){
    renderStorage();
    renderWeek();
  }

  noteEditBtn.onclick = () => {
    const item = findBoardItem(popState.day, popState.uid);
    if (!item) return closeNotePop();
    applyPopColorByKey(item.colorKey);
    setEditMode(item.label, item.note || "");
  };

  noteCancelBtn.onclick = () => {
    const item = findBoardItem(popState.day, popState.uid);
    if (!item) return closeNotePop();
    applyPopColorByKey(item.colorKey);
    setViewMode(item.label, item.note || "");
    refreshPopoverLayout();
  };

  noteSaveBtn.onclick = () => {
    const item = findBoardItem(popState.day, popState.uid);
    if (!item) return closeNotePop();

    const ed = document.getElementById("noteEditor");
    item.note = normalizeNote(ed ? ed.value : "");

    applyPopColorByKey(item.colorKey);
    setViewMode(item.label, item.note || "");
    saveState();
    renderWeek();
    refreshPopoverLayout();
  };

  noteCloseBtn.onclick = closeNotePop;
  modalBackdrop.onclick = closeNotePop;

  document.addEventListener("click", (e) => {
    const insidePop = notePop.contains(e.target);
    const onItem = e.target.closest && e.target.closest(".item");
    if (!insidePop && !onItem && notePop.style.display === "block"){
      closeNotePop();
    }
  });

  window.addEventListener("resize", () => {
    if (notePop.style.display === "block"){
      autoResizeNoteEditor();
      refreshPopoverLayout();
    }
  });

  addTaskBtn.onclick = addTask;
  taskInput.addEventListener("keydown", (e) => { if (e.key === "Enter") addTask(); });
  noteInput.addEventListener("keydown", (e) => { if (e.key === "Enter") addTask(); });

  newWeekBtn.onclick = () => {
    if (!confirm("새로운 주차를 시작할까요? 현재 배치가 모두 비워집니다.")) return;
    board = emptyBoard();
    selectedDay = "Mon";
    closeNotePop();
    saveState();
    renderWeek();
  };

  showSummaryBtn.onclick = () => {
    const lines = ["이번 주 배치 요약"];
    days.forEach(d => {
      const arr = board[d].map(x => `${x.done ? "✓ " : ""}${x.label}`);
      lines.push(`${d}: ${arr.length ? arr.join(", ") : "비어있음"}`);
    });
    alert(lines.join("\n"));
  };

  loadState();
  renderAll();
})();
</script>

<!-- 서비스워커 등록 -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js")
        .catch(err => console.log("SW register failed:", err));
    });
  }
</script>
</body>
</html>